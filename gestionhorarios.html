<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NailsCata - Gestión de Horarios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #fce4ec; /* Light pink background */
        }
        .container {
            max-width: 900px;
            margin: 40px auto;
            padding: 25px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(236, 72, 153, 0.1); /* Pink shadow */
        }
        h1 {
            color: #d81b60; /* Darker pink */
            text-align: center;
            margin-bottom: 30px;
        }
        .message {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
        }
        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #d81b60;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 p-4">
    <div class="container bg-white p-6 rounded-lg shadow-lg">
        <h1 class="text-3xl font-bold text-pink-700 mb-6">Gestión de Horarios de NailsCata</h1>

        <div id="form-message" class="message hidden"></div>

        <div class="mb-8">
            <h2 class="text-xl font-semibold text-pink-600 mb-4">Configurar Horarios Diarios</h2>
            <form id="schedule-form" class="space-y-4">
                <div>
                    <label for="dayOfWeek" class="block text-gray-700 text-sm font-bold mb-2">Día de la Semana:</label>
                    <select id="dayOfWeek" name="dayOfWeek" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <option value="">Selecciona un día</option>
                        <option value="0">Domingo</option>
                        <option value="1">Lunes</option>
                        <option value="2">Martes</option>
                        <option value="3">Miércoles</option>
                        <option value="4">Jueves</option>
                        <option value="5">Viernes</option>
                        <option value="6">Sábado</option>
                    </select>
                </div>
                <div>
                    <label for="availableTimes" class="block text-gray-700 text-sm font-bold mb-2">Horarios Disponibles (separados por coma, ej: 09:00,10:00,11:00):</label>
                    <input type="text" id="availableTimes" name="availableTimes" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Ej: 09:00,10:00,11:00">
                    <p class="text-xs text-gray-500 mt-1">Formato HH:MM (24 horas). Asegúrate de no dejar espacios entre las comas.</p>
                </div>
                <div class="flex items-center justify-between">
                    <button type="submit" class="bg-pink-500 hover:bg-pink-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                        Guardar Horario
                    </button>
                    <div id="loading-spinner" class="loading-spinner hidden"></div>
                </div>
            </form>
        </div>

        <div class="mb-8">
            <h2 class="text-xl font-semibold text-pink-600 mb-4">Horarios Configurados</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-pink-200 rounded-lg">
                    <thead>
                        <tr>
                            <th class="py-2 px-4 bg-pink-100 text-pink-700 border-b border-pink-200 text-left">Día</th>
                            <th class="py-2 px-4 bg-pink-100 text-pink-700 border-b border-pink-200 text-left">Horarios</th>
                            <th class="py-2 px-4 bg-pink-100 text-pink-700 border-b border-pink-200 text-left">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="schedules-table-body">
                        </tbody>
                </table>
            </div>
            <div id="no-schedules-message" class="text-gray-500 text-center py-4 hidden">No hay horarios configurados.</div>
        </div>
    </div>

    <script>
        // ¡CAMBIA ESTA URL por la de tu backend desplegado!
        // Ejemplo: const API_BASE_URL = 'https://tudominiobackend.render.com';
        const API_BASE_URL = 'https://cata-backend-5z45.onrender.com'; 

        const scheduleForm = document.getElementById('schedule-form');
        const dayOfWeekSelect = document.getElementById('dayOfWeek');
        const availableTimesInput = document.getElementById('availableTimes');
        const schedulesTableBody = document.getElementById('schedules-table-body');
        const formMessageEl = document.getElementById('form-message');
        const loadingSpinner = document.getElementById('loading-spinner');
        const noSchedulesMessage = document.getElementById('no-schedules-message');

        const dayNames = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"];

        function showMessage(message, type) {
            formMessageEl.textContent = message;
            formMessageEl.className = `message ${type}`;
            formMessageEl.classList.remove('hidden');
        }

        async function fetchSchedules() {
            loadingSpinner.classList.remove('hidden');
            schedulesTableBody.innerHTML = ''; // Limpiar tabla
            noSchedulesMessage.classList.add('hidden');

            try {
                const response = await fetch(`${API_BASE_URL}/api/schedules`);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                if (data.schedules.length === 0) {
                    noSchedulesMessage.classList.remove('hidden');
                } else {
                    data.schedules.forEach(schedule => {
                        const row = `
                            <tr class="hover:bg-pink-50">
                                <td class="py-2 px-4 border-b border-pink-200">${schedule.day_name}</td>
                                <td class="py-2 px-4 border-b border-pink-200">${schedule.available_times ? schedule.available_times.join(', ') : ''}</td>
                                <td class="py-2 px-4 border-b border-pink-200">
                                    <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded text-sm edit-btn" data-id="${schedule.day_of_week_num}" data-times="${schedule.available_times.join(',')}" data-name="${schedule.day_name}">
                                        Editar
                                    </button>
                                    <button class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-3 rounded text-sm delete-btn" data-id="${schedule.day_of_week_num}">
                                        Eliminar
                                    </button>
                                </td>
                            </tr>
                        `;
                        schedulesTableBody.insertAdjacentHTML('beforeend', row);
                    });
                }
            } catch (error) {
                console.error('Error al obtener horarios:', error);
                showMessage(`Error al cargar horarios: ${error.message}.`, 'error');
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        }

        async function saveSchedule(dayOfWeekNum, dayName, availableTimes) {
            loadingSpinner.classList.remove('hidden');
            try {
                const response = await fetch(`${API_BASE_URL}/api/schedules`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        day_of_week_num: dayOfWeekNum,
                        day_name: dayName,
                        available_times: availableTimes
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                showMessage('Horario guardado con éxito.', 'success');
                scheduleForm.reset();
                fetchSchedules(); // Actualizar la tabla
            } catch (error) {
                console.error('Error al guardar horario:', error);
                showMessage(`Error al guardar horario: ${error.message}.`, 'error');
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        }

        async function deleteSchedule(dayOfWeekNum) {
            if (!confirm('¿Estás seguro de que quieres eliminar el horario para este día? Esta acción no se puede deshacer.')) {
                return;
            }

            loadingSpinner.classList.remove('hidden');
            try {
                const response = await fetch(`${API_BASE_URL}/api/schedules/${dayOfWeekNum}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                showMessage('Horario eliminado con éxito.', 'success');
                fetchSchedules(); // Actualizar la tabla
            } catch (error) {
                console.error('Error al eliminar horario:', error);
                showMessage(`Error al eliminar horario: ${error.message}.`, 'error');
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        }

        scheduleForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const dayOfWeekNum = parseInt(dayOfWeekSelect.value);
            const dayName = dayNames[dayOfWeekNum];
            const timesString = availableTimesInput.value.trim();
            
            let availableTimes = [];
            if (timesString) {
                availableTimes = timesString.split(',').map(time => time.trim()).filter(time => time !== '');
            }

            if (isNaN(dayOfWeekNum) || dayOfWeekNum < 0 || dayOfWeekNum > 6) {
                showMessage('Por favor, selecciona un día de la semana válido.', 'error');
                return;
            }
            if (!availableTimes.length && timesString !== '') { // Si hay texto pero no se pudo parsear ningún horario
                 showMessage('Por favor, ingresa los horarios en el formato correcto (HH:MM,HH:MM).', 'error');
                 return;
            }

            saveSchedule(dayOfWeekNum, dayName, availableTimes);
        });

        schedulesTableBody.addEventListener('click', (event) => {
            if (event.target.classList.contains('edit-btn')) {
                const dayId = parseInt(event.target.dataset.id);
                const times = event.target.dataset.times;
                const name = event.target.dataset.name;

                dayOfWeekSelect.value = dayId;
                availableTimesInput.value = times;
                showMessage(`Editando horario para ${name}. Modifica y guarda.`, 'success');

            } else if (event.target.classList.contains('delete-btn')) {
                const dayId = parseInt(event.target.dataset.id);
                deleteSchedule(dayId);
            }
        });

        // Cargar horarios al cargar la página
        document.addEventListener('DOMContentLoaded', fetchSchedules);
    </script>
</body>
</html>